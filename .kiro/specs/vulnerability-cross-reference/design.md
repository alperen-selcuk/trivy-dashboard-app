# Design Document: Vulnerability Cross-Reference Tab

## Overview

This design implements a dedicated vulnerabilities tab that provides a cross-reference view of vulnerabilities across all images. Users can search for vulnerabilities by CVE code or description and see which images are affected, considering only active (latest) scans.

## Architecture

### Vulnerability Cross-Reference Flow

```
All Active Scans
    ↓
Extract All Vulnerabilities
    ↓
Deduplicate by CVE Code
    ↓
Build Vulnerability Index
    ↓
For Each Vulnerability: Find Affected Images
    ↓
Display in Vulnerabilities Tab
```

### Search and Filter Flow

```
User Search Query
    ↓
Match Against CVE Code, Description, Package
    ↓
Filter Results
    ↓
Display Matching Vulnerabilities
    ↓
User Clicks Vulnerability
    ↓
Show Affected Images (active scans only)
```

## Components and Interfaces

### Frontend Components

#### 1. VulnerabilitiesTab Component
```javascript
<VulnerabilitiesTab
  vulnerabilities={Vulnerability[]}
  onVulnerabilitySelect={handler}
/>
```

#### 2. VulnerabilitySearch Component
```javascript
<VulnerabilitySearch
  onSearch={handler}
  onFilter={handler}
/>
```

#### 3. VulnerabilityList Component
```javascript
<VulnerabilityList
  vulnerabilities={Vulnerability[]}
  onSelect={handler}
/>
```

#### 4. AffectedImagesPanel Component
```javascript
<AffectedImagesPanel
  vulnerability={Vulnerability}
  affectedImages={Image[]}
/>
```

### Backend Components

#### 1. Vulnerability Index Service
```python
class VulnerabilityIndexService:
    def build_vulnerability_index() -> Dict[str, Vulnerability]
    def get_affected_images(cve_code: str) -> List[Image]
    def search_vulnerabilities(query: str) -> List[Vulnerability]
    def get_vulnerability_by_cve(cve_code: str) -> Vulnerability
```

#### 2. Enhanced API Endpoints
- `GET /api/vulnerabilities` - Returns all unique vulnerabilities from active scans
- `GET /api/vulnerabilities/search?q={query}` - Search vulnerabilities
- `GET /api/vulnerabilities/{cve_code}` - Get specific vulnerability details
- `GET /api/vulnerabilities/{cve_code}/affected-images` - Get affected images

## Data Models

### Vulnerability Index Entry
```json
{
  "VulnerabilityID": "CVE-2021-12345",
  "Severity": "HIGH",
  "Description": "...",
  "PkgName": "openssl",
  "References": ["https://nvd.nist.gov/vuln/detail/CVE-2021-12345"],
  "AffectedImages": [
    {
      "image_name": "nginx",
      "version": "1.19",
      "scan_time": "2024-01-15T10:30:00Z",
      "installed_version": "1.1.1",
      "fixed_version": "1.1.1k"
    }
  ],
  "AffectedImageCount": 2
}
```

### Search Result
```json
{
  "VulnerabilityID": "CVE-2021-12345",
  "Severity": "HIGH",
  "Description": "...",
  "AffectedImageCount": 2,
  "MatchType": "cve_code" | "description" | "package"
}
```

## UI Layout

### Vulnerabilities Tab Structure
```
┌─────────────────────────────────────┐
│ Vulnerabilities Tab                 │
├─────────────────────────────────────┤
│ [Search Box] [Severity Filter]      │
├─────────────────────────────────────┤
│ Vulnerability List                  │
│ ┌─────────────────────────────────┐ │
│ │ CVE-2021-12345 | HIGH | 2 images│ │
│ │ CVE-2021-54321 | MEDIUM | 1 img │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ Affected Images (when selected)     │
│ ┌─────────────────────────────────┐ │
│ │ nginx:1.19 | HIGH | 1.1.1       │ │
│ │ nginx:1.20 | HIGH | 1.1.1       │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

## Correctness Properties

A property is a characteristic or behavior that should hold true across all valid executions of a system—essentially, a formal statement about what the system should do.

### Property 1: Vulnerability Uniqueness
**For any** set of active scans, the vulnerability index should contain each unique CVE code exactly once, regardless of how many images contain it.

**Validates: Requirements 1.1, 1.2**

### Property 2: Active Scans Only
**For any** vulnerability displayed in the vulnerabilities tab, all affected images should come from active (latest) scans only.

**Validates: Requirements 2.2, 3.5**

### Property 3: Search Result Accuracy
**For any** search query, all returned vulnerabilities should match the query against CVE code, description, or package name.

**Validates: Requirements 2.1, 2.2, 2.3**

### Property 4: Affected Images Consistency
**For any** vulnerability, the affected images list should match the images that contain that vulnerability in their active scans.

**Validates: Requirements 3.1, 3.2**

### Property 5: CVE Reference Completeness
**For any** vulnerability with a CVE code, the reference link should be present and properly formatted.

**Validates: Requirements 5.1, 5.2, 5.3**

## Error Handling

1. **No Vulnerabilities Found**: Display "No vulnerabilities found" message
2. **Search Returns No Results**: Display "No results match your search"
3. **Invalid CVE Code**: Display error message
4. **Missing Reference Link**: Display "Reference not available"
5. **Database Query Failure**: Display error and retry option

## Testing Strategy

### Unit Tests
- Test vulnerability index building
- Test search functionality with various queries
- Test affected images filtering
- Test CVE reference link generation

### Property-Based Tests
- **Property 1**: Generate random scans, verify unique CVE codes
- **Property 2**: Generate mixed active/inactive scans, verify only active shown
- **Property 3**: Generate vulnerabilities, verify search accuracy
- **Property 4**: Generate vulnerability data, verify affected images match
- **Property 5**: Generate vulnerabilities, verify CVE references

### Integration Tests
- Test vulnerabilities tab display
- Test search and filter functionality
- Test affected images panel
- Test CVE link opening
- Test with large vulnerability datasets

