# Design Document: Vulnerability Deduplication

## Overview

This design addresses the vulnerability counting issue where the same vulnerability appearing in multiple image versions is counted multiple times. The solution implements deduplication logic at the backend and frontend levels to ensure accurate vulnerability counts based on the latest scan for each image version.

## Architecture

The deduplication system operates at two levels:

1. **Backend Level**: Database queries and data processing
2. **Frontend Level**: Data grouping and aggregation

### Backend Architecture

```
API Request
    ↓
Database Query (all scans)
    ↓
Group by Image + Version
    ↓
Select Latest Scan per Version
    ↓
Deduplicate Vulnerabilities
    ↓
Return Aggregated Data
```

### Frontend Architecture

```
Raw API Response
    ↓
Group by Base Image Name
    ↓
For Each Version: Select Latest Scan
    ↓
Aggregate Unique Vulnerabilities
    ↓
Display in DataGrid
```

## Components and Interfaces

### Backend Components

#### 1. ScanResultDB Model Enhancement
- Add `is_latest` flag to track latest scan per version
- Add `vulnerability_hash` for deduplication

#### 2. Deduplication Service
```python
class DeduplicationService:
    def get_latest_scans_by_version(image_name: str) -> List[ScanResult]
    def deduplicate_vulnerabilities(scans: List[ScanResult]) -> List[Vulnerability]
    def get_unique_vulnerabilities_across_versions(image_name: str) -> List[Vulnerability]
```

#### 3. Enhanced API Endpoints
- `GET /api/scan-results` - Returns deduplicated results
- `GET /api/images/{image_name}/latest-scans` - Returns latest scan per version
- `GET /api/images/{image_name}/unique-vulnerabilities` - Returns unique vulnerabilities

### Frontend Components

#### 1. Data Processing Hook
```javascript
useDeduplicatedScanResults() -> {
  scanResults: Array,
  loading: boolean,
  error: string
}
```

#### 2. Vulnerability Aggregation
- Group vulnerabilities by CVE code
- Track which versions contain each vulnerability
- Calculate unique count

## Data Models

### Enhanced ScanResult
```json
{
  "id": 1,
  "image_name": "nginx:1.19",
  "scan_time": "2024-01-15T10:30:00Z",
  "is_latest": true,
  "vulnerabilities": [
    {
      "VulnerabilityID": "CVE-2021-12345",
      "PkgName": "openssl",
      "Severity": "HIGH",
      "InstalledVersion": "1.1.1",
      "FixedVersion": "1.1.1k",
      "Description": "...",
      "References": ["https://nvd.nist.gov/vuln/detail/CVE-2021-12345"]
    }
  ]
}
```

### Deduplicated Vulnerability
```json
{
  "VulnerabilityID": "CVE-2021-12345",
  "Severity": "HIGH",
  "AffectedVersions": ["nginx:1.19", "nginx:1.20"],
  "UniqueCount": 1,
  "FirstSeen": "2024-01-15T10:30:00Z"
}
```

## Correctness Properties

A property is a characteristic or behavior that should hold true across all valid executions of a system—essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.

### Property 1: Latest Scan Selection
**For any** image version, when multiple scans exist, the system should select and display only the scan with the most recent scan_time.

**Validates: Requirements 1.2, 1.3**

### Property 2: Vulnerability Deduplication
**For any** set of vulnerabilities from multiple scans of the same image, the deduplicated count should equal the number of unique vulnerability IDs across all scans.

**Validates: Requirements 1.1, 2.1**

### Property 3: Unique Vulnerability Aggregation
**For any** image with multiple versions, the total unique vulnerability count should be less than or equal to the sum of vulnerabilities across all versions (accounting for duplicates).

**Validates: Requirements 2.2, 2.3**

### Property 4: Scan Metadata Consistency
**For any** displayed image version, the scan_time shown should match the scan_time of the latest scan for that version in the database.

**Validates: Requirements 3.1, 3.2**

## Error Handling

1. **No Scans Found**: Display "No scans available" message
2. **Database Connection Error**: Fall back to cached data or display error
3. **Malformed Vulnerability Data**: Skip invalid entries and log error
4. **Duplicate Handling Failure**: Display raw data with warning

## Testing Strategy

### Unit Tests
- Test deduplication logic with various vulnerability sets
- Test latest scan selection with multiple timestamps
- Test edge cases (empty scans, single scan, identical vulnerabilities)

### Property-Based Tests
- **Property 1**: Generate random scans with different timestamps, verify latest is selected
- **Property 2**: Generate random vulnerability lists, verify deduplication count
- **Property 3**: Generate multi-version scans, verify aggregation logic
- **Property 4**: Generate scan data, verify metadata consistency

### Integration Tests
- Test end-to-end flow from database to frontend display
- Test with real Trivy scan data
- Test performance with large datasets

