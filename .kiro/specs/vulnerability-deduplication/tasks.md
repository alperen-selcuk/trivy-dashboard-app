# Implementation Plan: Vulnerability Deduplication

## Overview

This implementation plan breaks down the vulnerability deduplication feature into discrete coding tasks. The approach focuses on backend data processing first, then frontend aggregation, ensuring accurate vulnerability counts based on latest scans.

## Tasks

- [x] 1. Create deduplication service in backend
  - Create `DeduplicationService` class with methods for latest scan selection
  - Implement `get_latest_scans_by_version()` to select most recent scan per version
  - Implement `deduplicate_vulnerabilities()` to remove duplicate CVEs
  - _Requirements: 1.2, 1.3, 2.1_

- [x]* 1.1 Write property tests for deduplication logic
  - **Property 1: Latest Scan Selection**
  - **Property 2: Vulnerability Deduplication**
  - **Validates: Requirements 1.2, 2.1**

- [x] 2. Enhance ScanResultDB model
  - Add `is_latest` boolean field to track latest scan per version
  - Add database migration for new field
  - Update model initialization logic
  - _Requirements: 1.1, 1.3_

- [x] 3. Create new API endpoint for deduplicated results
  - Create `GET /api/scan-results/deduplicated` endpoint
  - Implement deduplication logic in endpoint
  - Return aggregated vulnerability counts
  - _Requirements: 1.1, 2.2, 3.1_

- [x]* 3.1 Write property tests for API endpoint
  - **Property 3: Unique Vulnerability Aggregation**
  - **Property 4: Scan Metadata Consistency**
  - **Validates: Requirements 2.2, 3.1**

- [x] 4. Update frontend data processing
  - Modify `useEffect` hook to use new deduplicated endpoint
  - Update data grouping logic to handle deduplicated results
  - Remove duplicate aggregation logic from frontend
  - _Requirements: 1.1, 2.2_

- [x] 5. Update vulnerability display in DataGrid
  - Modify vulnerability count display to show deduplicated counts
  - Update vulnerability details column to show unique vulnerabilities
  - Ensure CVE codes are displayed correctly
  - _Requirements: 1.1, 2.2, 4.1_

- [x] 6. Checkpoint - Ensure all tests pass
  - Ensure all unit tests pass
  - Ensure all property tests pass
  - Verify deduplication logic with sample data

- [x] 7. Test with real Trivy data
  - Create test dataset with multiple image versions
  - Verify deduplication works correctly
  - Verify counts match expected values
  - _Requirements: 1.1, 1.2, 2.1_

- [x]* 7.1 Write integration tests
  - Test end-to-end deduplication flow
  - Test with various vulnerability patterns
  - Test performance with large datasets

